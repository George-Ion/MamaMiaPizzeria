{% extends "layout.html" %}

{% block title %}Order #{{ order.order_id }} - Mamma Mia Pizza{% endblock %}

{% block content %}
<div class="card">
    <h1>üìã Order #{{ order.order_id }} Details</h1>
    <a href="{{ url_for('orders.show_orders') }}" class="btn">‚Üê Back to Orders</a>
</div>

<div class="stats-grid">
    <div class="card">
        <h3>üë§ Customer Information</h3>
        <p><strong>Name:</strong> {{ user.first_name }} {{ user.last_name }}</p>
        <p><strong>Email:</strong> {{ user.email }}</p>
        <p><strong>Phone:</strong> {{ user.phone or 'Not provided' }}</p>
        <p><strong>Address:</strong> {{ user.address or 'Not provided' }}</p>
        <p><strong>Postal Code:</strong> {{ user.postal_code or 'Not provided' }}</p>
        
        {% if customer.total_pizzas_ordered >= 10 %}
        <div class="alert alert-success">
            This is a loyalty customer! ({{ customer.total_pizzas_ordered }} pizzas ordered)
        </div>
        {% endif %}
    </div>

    <div class="card">
        <h3>üì¶ Order Information</h3>
        <p><strong>Order Date:</strong> {{ order.created_at.strftime('%Y-%m-%d at %H:%M') }}</p>
        <p><strong>Status:</strong> 
            <span class="status-{{ order.delivery_status.lower().replace(' ', '-') }}">
                {% if order.delivery_status == 'Pending' %}
                    Pending
                {% else %}
                    {% if order.delivery_status == 'In Progress' %}
                        In Progress
                    {% else %}
                        {% if order.delivery_status == 'Out for Delivery' %}
                            Out for Delivery
                        {% else %}
                            {% if order.delivery_status == 'Delivered' %}
                                Delivered
                            {% else %}
                                {% if order.delivery_status == 'Cancelled' %}
                                    Cancelled
                                {% endif %}
                            {% endif %}
                        {% endif %}
                    {% endif %}
                {% endif %}
            </span>
        </p>
        
        {% if order.staff_id %}
        <p><strong>Assigned Staff:</strong> Staff ID {{ order.staff_id }}</p>
        {% else %}
        <p><strong>Assigned Staff:</strong> <em>Not assigned yet</em></p>
        {% endif %}
        
        <p><strong>Discount Applied:</strong> ‚Ç¨{{ "%.2f"|format(order.discount_amount or 0) }}</p>
        <p><strong>Final Total:</strong> <span class="price">‚Ç¨{{ "%.2f"|format(order.final_total or 0) }}</span></p>
    </div>
</div>

<div class="card">
    <h2>üõí Order Items</h2>
    {% if items %}
    <table>
        <thead>
            <tr>
                <th>Item</th>
                <th>Type</th>
                <th>Quantity</th>
                <th>Unit Price</th>
                <th>Total Price</th>
            </tr>
        </thead>
        <tbody>
            {% for item in items %}
            <tr>
                <td>
                    <strong>
                        {% if item.item_type == 'Pizza' and item.pizza_info %}
                            {{ item.pizza_info.name }}
                            {% if item.pizza_info.is_vegetarian %}üå±{% endif %}
                            {% if item.pizza_info.is_vegan %}üåø{% endif %}
                        {% endif %}
                        {% if item.item_type == 'Drink' and item.drink_info %}
                            {{ item.drink_info.name }}
                        {% endif %}
                        {% if item.item_type == 'Dessert' and item.dessert_info %}
                            {{ item.dessert_info.name }}
                        {% endif %}
                    </strong>
                </td>
                <td>
                    {% if item.item_type == 'Pizza' %}
                        üçï Pizza
                    {% elif item.item_type == 'Drink' %}
                        ü•§ Drink
                    {% elif item.item_type == 'Dessert' %}
                        üç∞ Dessert
                    {% endif %}
                </td>
                <td>{{ item.quantity }}</td>
                <td class="price">
                    {% if item.item_type == 'Pizza' and item.pizza_info %}
                        ‚Ç¨{{ "%.2f"|format(item.pizza_info.final_price) }}
                    {% elif item.item_type == 'Drink' and item.drink_info %}
                        ‚Ç¨{{ "%.2f"|format(item.drink_info.price) }}
                    {% elif item.item_type == 'Dessert' and item.dessert_info %}
                        ‚Ç¨{{ "%.2f"|format(item.dessert_info.price) }}
                    {% else %}
                        ‚Ç¨0.00
                    {% endif %}
                </td>
                <td class="price">‚Ç¨{{ "%.2f"|format(item.total_price) }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    
    <div class="order-items">
        <h4>üí∞ Order Summary</h4>
        {% set subtotal = items|sum(attribute='total_price') %}
        <p><strong>Subtotal:</strong> ‚Ç¨{{ "%.2f"|format(subtotal) }}</p>
        <p><strong>Discount:</strong> -‚Ç¨{{ "%.2f"|format(order.discount_amount or 0) }}</p>
        <hr>
        <p style="font-size: 1.2em;"><strong>Final Total:</strong> <span class="price">‚Ç¨{{ "%.2f"|format(order.final_total or 0) }}</span></p>
    </div>
    
    {% else %}
    <p>No items found for this order.</p>
    {% endif %}
</div>

{% if order.delivery_status in ['Pending', 'In Progress', 'Out for Delivery'] %}
<div class="card">
    <h3>Order Actions</h3>
    {% if order.delivery_status == 'Pending' %}
        <p>Order is pending - waiting for driver assignment</p>
        <a href="{{ url_for('orders.delivery_status') }}" class="btn btn-primary">View Available Drivers</a>
    {% elif order.delivery_status == 'In Progress' %}
        <p>Order is being prepared</p>
        <form method="POST" action="#" style="display: inline;">
            <button type="submit" class="btn btn-primary">Mark as Out for Delivery</button>
        </form>
    {% elif order.delivery_status == 'Out for Delivery' %}
        <p>Order is out for delivery</p>
        <form method="POST" action="{{ url_for('orders.complete_delivery', order_id=order.order_id) }}" style="display: inline;">
            <button type="submit" class="btn btn-success" onclick="return confirm('Mark this delivery as completed?')">
                Complete Delivery
            </button>
        </form>
    {% endif %}
    
    {% if order.delivery_status != 'Cancelled' %}
        <form method="POST" action="#" style="display: inline;">
            <button type="submit" class="btn btn-danger" onclick="return confirm('Are you sure you want to cancel this order?')">
                Cancel Order
            </button>
        </form>
    {% endif %}
</div>
{% endif %}

<style>
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 1rem;
    margin: 1rem 0;
}
.status-pending { background: #ffd700; padding: 4px 8px; border-radius: 4px; }
.status-in-progress { background: #00bcd4; color: white; padding: 4px 8px; border-radius: 4px; }
.status-out-for-delivery { background: #2196f3; color: white; padding: 4px 8px; border-radius: 4px; }
.status-delivered { background: #4caf50; color: white; padding: 4px 8px; border-radius: 4px; }
.status-cancelled { background: #f44336; color: white; padding: 4px 8px; border-radius: 4px; }
.alert { padding: 1rem; border-radius: 4px; margin: 1rem 0; }
.alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
</style>
{% endblock %}